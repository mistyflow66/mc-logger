<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éº¥å¡Šå†’éšª</title>
  <style>
    :root { --mc-green: #388E3C; --mc-dirt: #795548; --mc-stone: #424242; }
    body { font-family: 'Segoe UI', sans-serif; background: #2c2c2c; color: white; padding: 15px; text-align: center; margin:0; }
    .container { background: #3c3c3c; border: 4px solid #000; padding: 20px; border-radius: 4px; max-width: 400px; margin: auto; }
    h2 { color: #8bc34a; text-shadow: 2px 2px #000; margin: 10px 0; }
    .dashboard { background: #000; border: 4px solid #555; padding: 15px; margin-bottom: 15px; }
    .balance-value { color: #00e676; font-size: 32px; font-weight: bold; font-family: 'Courier New', monospace; }
    .user-select { background: #4e4e4e; border: 2px solid #000; padding: 10px; margin-bottom: 15px; display: flex; justify-content: space-around; align-items: center; }
    .radio-group { cursor: pointer; display: flex; align-items: center; }
    select, input { width: 100%; padding: 12px; margin-bottom: 10px; border: 3px solid #000; background: #fff; box-sizing: border-box; font-size: 16px; color: #000; }
    button { width: 100%; padding: 15px; background: var(--mc-green); color: white; border: 3px solid #1b5e20; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 4px #1b5e20; }
    .daily-log { background: #252525; border: 2px solid #555; padding: 10px; margin-top: 15px; text-align: left; }
    .log-title { border-bottom:1px solid #555; font-weight:bold; color: #ffeb3b; margin-bottom: 5px; }
    .score-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; color: #fff; }
    .score-table td, .score-table th { border: 1px solid #555; padding: 6px; text-align: center; }
    .score-table th { background: #795548; }
    .hidden { display: none !important; }
    #chestGallery { display: flex; flex-wrap: wrap; gap: 5px; background: #1e1e1e; padding: 10px; margin-top: 5px; border-radius: 5px; }
    .stamp-card { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 10px 15px; margin-top: 10px; border: 2px solid #555; }
    .stamp-item { font-size: 14px; color: #ffeb3b; flex: 1; text-align: center; white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ’ å†’éšªå„€è¡¨æ¿</h2>
    <div id="timer" style="font-size: 12px; color: #aaa; margin-bottom: 10px;">è¼‰å…¥ä¸­...</div>

    <div class="dashboard">
      <div style="color:#fff; font-size:14px;">ğŸ”‹ ç›®å‰ 3C èƒ½é‡</div>
      <div class="balance-value" id="balanceDisplay">0</div>
      <div class="stamp-card">
        <div class="stamp-item">â­ è‡ªå·±èµ·åºŠ: <span id="wakeupCount">0</span>/10</div>
        <div class="stamp-item">â¤ï¸ GOOD: <span id="goodCount">0</span>/10</div>
      </div>
    </div>

    <div class="user-select">
      <span>è§’è‰²:</span>
      <label class="radio-group"><input type="radio" name="user" value="å‰" checked onclick="switchUser('å‰')"> å‰</label>
      <label class="radio-group"><input type="radio" name="user" value="å§" onclick="switchUser('å§')"> å§</label>
    </div>

    <div id="passwordArea" class="hidden">
      <input type="password" id="passwordInput" placeholder="è¼¸å…¥å¯†ç¢¼">
    </div>

    <form id="questForm">
      <select id="typeSelect" onchange="updateItems()" required></select>
      <select id="itemSelect" onchange="checkValueType()" required></select>
      <div id="valueArea">
        <input id="valueInput" placeholder="æ•¸é‡/åˆ†æ•¸">
      </div>
      <input type="text" id="noteInput" placeholder="å¯«é»å‚™è¨»..."> 
      <button type="button" onclick="submitForm()">ğŸ’¾ å­˜æª”ç´€éŒ„</button>
    </form>

    <div id="chestSection" style="margin-top:10px; text-align:left;">
      <div style="cursor:pointer; color:#55efc4; font-size:14px;" onclick="toggleChest()">ğŸ“¦ æˆ‘çš„å¯¶ç®± (é»é–‹ç›¸ç°¿)</div>
      <div id="chestGallery" class="hidden"></div>
    </div>

    <div id="giftArea" class="hidden" style="margin-top:20px; background:#000; border:3px dashed #ffeb3b; padding:10px;">
      <div style="color:#ffeb3b;">ğŸ ç™¼ç¾æ‰è½ç‰©ï¼</div>
      <img id="luckyGif" src="" style="width:100%; border-radius:8px;">
    </div>
    
    <div class="daily-log">
      <div class="log-title">ğŸ“… ä»Šå¤©çš„æ—¥èªŒ</div>
      <div id="todayList" style="color:#8bc34a; font-size: 14px;"></div>
    </div>

    <div class="daily-log" style="border-color: #fab1a0;">
      <div class="log-title" style="color: #ff7675;">ğŸ“¢ æ‚„æ‚„è©±ç•™è¨€æ¿</div>
      <div id="noteList" style="font-size: 13px; color: #dfe6e9;"></div>
    </div>

    <div class="daily-log" style="border-color: #8bc34a;">
      <div class="log-title" style="color: #8bc34a;">ğŸ“Š é‹å‹•æ›ç®—è¡¨</div>
      <table class="score-table">
        <thead>
          <tr><th>é …ç›®</th><th>åŸºæº–å–®ä½</th><th>èƒ½é‡</th></tr>
        </thead>
        <tbody>
          <tr><td>è·³ç¹©</td><td>100 ä¸‹</td><td>+ 5</td></tr>
          <tr><td>è·‘æ­¥</td><td>200 å…¬å°º</td><td>+ 5</td></tr>
          <tr><td>ä»°è‡¥èµ·å</td><td>1 åˆ†é˜</td><td>+ 5</td></tr>
          <tr style="color: #ffeb3b; background: #333;"><td>â­ è‡ªå·±èµ·åºŠ</td><td>æ»¿ 10 æ¬¡</td><td>+ 5 (é¡å¤–çå‹µ)</td></tr>
          <tr style="color: #ffeb3b; background: #333;"><td>â¤ï¸ GOOD</td><td>æ»¿ 10 æ¬¡</td><td>+ 10 (é¡å¤–çå‹µ)</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const gasUrl = "https://script.google.com/macros/s/AKfycby8MaeORmgHynbc4qTnjUUCyn12NWZYJP6HEhCZ1wEsXOX3fnTlQT-LP9l8FRNQf4cG/exec"; 
    const openingDate = new Date("2026-02-23");
    const optionsMap = {
      "å‰": { "é‹å‹•": ["è·³ç¹©", "è·‘æ­¥", "ä»°è‡¥èµ·å"], "3C": ["çœ‹é›»è¦–", "ç”¨æ‰‹æ©Ÿ", "ç©é›»è…¦"], "è¦åŠƒ": ["é–±è®€", "åšå°æ›¸", "ç·´ç¿’è‹±æ–‡", "å…¶ä»–"] },
      "å§": { "é‹å‹•": ["è·³ç¹©", "è·‘æ­¥", "ä»°è‡¥èµ·å"], "3C": ["çœ‹é›»è¦–", "ç”¨æ‰‹æ©Ÿ", "ç©é›»è…¦"], "çå‹µ": ["è‡ªå·±èµ·åºŠ", "GOOD", "åŠ åˆ†", "æ‰£åˆ†"] }
    };

    const randomPlaceholders = [
      "å¯«é»æ‚„æ‚„è©±...",
      "é‚„åœ¨ã„Šã„Ÿ",
      "ç¾åœ¨çš„å¿ƒæƒ…...",
      "(â ãƒ»â âˆ€â ãƒ»â )",
      "(â ã†â Ï‰â ã†â )",
      "(â â—â â€¢â á´—â â€¢â â—â )",
      "ä»Šå¤©é‹å‹•äº†å—ï¼Ÿ"
    ];

    function setRandomPlaceholder() {
      const randomIndex = Math.floor(Math.random() * randomPlaceholders.length);
      document.getElementById('noteInput').placeholder = randomPlaceholders[randomIndex];
    }

    function updateTimer() {
      const now = new Date();
      const diff = openingDate - now;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      document.getElementById('timer').innerText = `æ›´æ–°ï¼š${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} | è·é›¢é–‹å­¸ï¼š${days} å¤© ${hours} æ™‚`;
    }

    function switchUser(user) {
      document.getElementById('passwordArea').classList.toggle('hidden', user !== 'å§');
      const typeSelect = document.getElementById('typeSelect');
      typeSelect.innerHTML = '<option value="">-- é¸æ“‡é¡åˆ¥ --</option>';
      Object.keys(optionsMap[user]).forEach(t => typeSelect.add(new Option(t, t)));
      updateItems();
    }

    function updateItems() {
      const user = document.querySelector('input[name="user"]:checked').value;
      const type = document.getElementById('typeSelect').value;
      const itemSelect = document.getElementById('itemSelect');
      itemSelect.innerHTML = '<option value="">-- é¸æ“‡é …ç›® --</option>';
      if (optionsMap[user][type]) {
        optionsMap[user][type].forEach(i => itemSelect.add(new Option(i, i)));
      }
      checkValueType();
    }

    function checkValueType() {
      const type = document.getElementById('typeSelect').value;
      const item = document.getElementById('itemSelect').value;
      const valInput = document.getElementById('valueInput');
      if (type === "è¦åŠƒ" || item === "å…¶ä»–") {
        valInput.type = "text";
        valInput.placeholder = "åšäº†ä»€éº¼ï¼Ÿ";
      } else {
        valInput.type = "number";
        valInput.placeholder = "è¼¸å…¥æ•¸é‡(æ•¸å­—)";
      }
    }

    function refreshData() {
      fetch(`${gasUrl}?action=readData`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('balanceDisplay').innerText = data.total3C || 0;
          document.getElementById('todayList').innerHTML = (data.todayLogs && data.todayLogs.length > 0) ? data.todayLogs.join("<br>") : "ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„";
          document.getElementById('wakeupCount').innerText = data.wakeup || 0;
          document.getElementById('goodCount').innerText = data.good || 0;
          document.getElementById('noteList').innerHTML = (data.notes && data.notes.length > 0) ? data.notes.join("<br>") : "ç›®å‰æ²’æœ‰ç•™è¨€";
          const gallery = document.getElementById('chestGallery');
          gallery.innerHTML = data.myChest.map(url => `<img src="${url}" style="width:50px;height:50px;object-fit:cover;">`).join("");
        })
        .catch(err => console.error("æŠ“å–è³‡æ–™å¤±æ•—:", err));
    }

    function submitForm() {
      const user = document.querySelector('input[name="user"]:checked').value;
      const submitBtn = document.querySelector('button[onclick="submitForm()"]');

      if (user === 'å§' && document.getElementById('passwordInput').value !== "3672") {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼"); return;
      }
      
      const type = document.getElementById('typeSelect').value;
      const item = document.getElementById('itemSelect').value;
      const valRaw = document.getElementById('valueInput').value.trim();
      const note = document.getElementById('noteInput').value.trim(); 
      
      if (!type || !item) { alert("è«‹é¸æ“‡é¡åˆ¥å’Œé …ç›®ï¼"); return; }

      const isTextMode = (type === "è¦åŠƒ" || item === "å…¶ä»–");
      if (!valRaw) {
        alert(isTextMode ? "è«‹è¼¸å…¥ã€åšäº†ä»€éº¼ã€ï¼" : "è«‹è¼¸å…¥ã€æ•¸é‡æ•¸å­—ã€ï¼"); return;
      }
      if (!isTextMode && isNaN(valRaw)) {
        alert("é€™é …è«‹è¼¸å…¥ã€æ•¸å­—ã€ï¼Œä¸è¦è¼¸å…¥æ–‡å­—ï¼"); return;
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "â³ å‚³é€ä¸­...";
      submitBtn.style.background = "#95a5a6";

      const finalVal = isTextMode ? 0 : valRaw;
      const otherNote = isTextMode ? valRaw : "";
      const url = `${gasUrl}?action=addData&user=${user}&category=${type}&item=${item}&value=${finalVal}&otherNote=${encodeURIComponent(otherNote)}&note=${encodeURIComponent(note)}`;
      
      fetch(url)
        .then(res => res.text())
        .then(giftUrl => {
          if (user === "å‰" && giftUrl && !["Error", "Success"].includes(giftUrl)) {
            document.getElementById('giftArea').classList.remove('hidden');
            document.getElementById('luckyGif').src = giftUrl;
            alert("ç™¼ç¾æ‰è½ç‰©ï¼");
          } else {
            alert("å­˜æª”æˆåŠŸï¼");
          }
          clearFormAfterSubmit();
          refreshData();
        })
        .catch(err => {
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.innerText = "ğŸ’¾ å­˜æª”ç´€éŒ„";
          submitBtn.style.background = "var(--mc-green)";
        });
    }

    function clearFormAfterSubmit() {
      document.getElementById('typeSelect').value = "";
      document.getElementById('itemSelect').innerHTML = '<option value="">-- é¸æ“‡é …ç›® --</option>';
      document.getElementById('valueInput').value = "";
      document.getElementById('noteInput').value = ""; 
      setRandomPlaceholder(); 
    }

    function toggleChest() { document.getElementById('chestGallery').classList.toggle('hidden'); }
    
    window.onload = () => { 
      switchUser('å‰'); 
      refreshData(); 
      updateTimer(); 
      setRandomPlaceholder();
      setInterval(updateTimer, 60000);
    };
  </script>
</body>
</html>
